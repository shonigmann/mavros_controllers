<?xml version="1.0"?>
<launch>
<!-- want to use iris_depth_camera -->
  <arg name="mav_name" default="iris_depth_camera"/>
  <arg name="fcu_url" default="udp://:14540@127.0.0.1:14557"/>
  <arg name="gcs_url" default="" />
  <arg name="tgt_system" default="1" />
  <arg name="tgt_component" default="1" />
  <arg name="command_input" default="2" />
  <arg name="gazebo_simulation" default="true" />
  <arg name="visualization" default="true"/> <!-- changed to stop rviz from popping up -->
  <arg name="log_output" default="screen" />
  <arg name="fcu_protocol" default="v2.0" />
  <arg name="respawn_mavros" default="false" />
  <arg name="world_file" default="collapsed_building" />
  
  <node pkg="geometric_controller" type="geometric_controller_node" name="geometric_controller" output="screen">
          <param name="mav_name" type="string" value="$(arg mav_name)" />
          <remap from="command/bodyrate_command" to="/mavros/setpoint_raw/attitude"/>
          <param name="ctrl_mode" value="$(arg command_input)" />
          <param name="enable_sim" value="$(arg gazebo_simulation)" />
          <param name="enable_gazebo_state" value="true"/>
          <param name="max_acc" value="1.0" />
          <param name="Kp_x" value="8.0" />
          <param name="Kp_y" value="8.0" />
          <param name="Kp_z" value="8.0" />
          <param name="Kv_x" value="3.0" />
          <param name="Kv_y" value="3.0" />
          <param name="Kv_z" value="6.0" />
	  <param name="velocity_yaw" value="false"/>
  </node>
<!-- added velocity_yaw param to try and control the MAVs velocity... will need a publisher for this? actually, looks like yaw is determined by atan2(v_y, v_x); i.e. point towards forward direction -->


  <node pkg="trajectory_publisher" type="trajectory_publisher" name="trajectory_publisher" output="screen">
        <param name="trajectory_type" value="3" /> <!-- 0 for polynomial, 1 for circle, 2 for lamniscate, 3 for stationary  -->
        <param name="shape_omega" value=".2" /> <!-- rate of rotation around shape trajectories -->
       <!-- <param name="initpos_x" value="0.30" /> -->
     <!--   <param name="initpos_y" value="-1.60" /> -->
        <param name="initpos_z" value="0.50" />
        <param name="reference_type" value="16" />
            <!-- 2 has no meaning as far as i can tell. meaningful values are 0 (default (pos,vel,accel (no orientation)), no accel target), 8 (Twist reference) and 16 (Raw pos reference (no orientation, no accel)) -->

  </node>

  <!-- Launch rqt_reconfigure -->
<!-- ###THIS allows you to dynamically reconfigure params during the simulation... not needed for now
  <node pkg="rqt_reconfigure" type="rqt_reconfigure" output="screen" name="rqt_reconfigure" />
-->

  <include file="$(find mavros)/launch/node.launch">
      <arg name="pluginlists_yaml" value="$(find mavros)/launch/px4_pluginlists.yaml" />
      <arg name="config_yaml" value="$(find mavros)/launch/px4_config.yaml" />

      <arg name="fcu_url" value="$(arg fcu_url)" />
      <arg name="gcs_url" value="$(arg gcs_url)" />
      <arg name="tgt_system" value="$(arg tgt_system)" />
      <arg name="tgt_component" value="$(arg tgt_component)" />
      <arg name="log_output" value="$(arg log_output)" />
      <arg name="fcu_protocol" value="$(arg fcu_protocol)" />
      <arg name="respawn_mavros" default="$(arg respawn_mavros)" />
  </include>

<!-- want to use posix_sitl_in_world.launch -->
  <include file="$(find px4)/launch/posix_sitl_in_world.launch">
      <arg name="vehicle" value="$(arg mav_name)"/>
      <arg name="world_file" value="$(arg world_file)"/>
<!-- the place to change the selected gazebo world is in here! --> 
  </include>

<!-- adding launch for ORB SLAM 2 here! this doesn't work... <include file="$(find orb_slam_2_ros)/ros/launch/orb_slam2_d435_rgbd.launch"> -->
  <include file="/home/simon/catkin_ws/src/orb_slam_2_ros/ros/launch/orb_slam2_d435_rgbd.launch">
  </include>

 
<!--
  <group if="$(arg visualization)">
      <node type="rviz" name="rviz_traj" pkg="rviz" args="-d $(find geometric_controller)/launch/config_file.rviz" />
  </group>
 -->
  <group if="$(arg visualization)">
      <node type="rviz" name="rviz_cam" pkg="rviz" args="-d $(find geometric_controller)/launch/rgbd_config_file.rviz" />
  </group>

<!--
  <node pkg="rosbag" type="play" name="rosbag" required="true" args="/home/simon/catkin_ws/src/mavros_controllers/test.bag"/>

  <node name="extract_rgb" pkg="image_view" type="extract_images" respawn="false" required="true" output="screen" cwd="ROS_HOME">
    <remap from="image" to="/camera/rgb/image_raw"/>
  </node> -->


  <node pkg="flat_waypoint_publisher" type="flat_publisher.py" name="flat_publisher" output="screen">
  </node>

</launch>
